# HiTutor好会帮 —— 程序鉴别材料

## 一、前端源代码

### 1.1 应用入口文件 (main.dart)

```dart
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';

import 'routes.dart';
import 'theme/app_theme.dart';

import 'providers/auth_provider.dart';
import 'providers/tutor_provider.dart';
import 'providers/message_provider.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  runApp(const HiTutorApp());
}

class HiTutorApp extends StatelessWidget {
  const HiTutorApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MultiProvider(
      providers: [
        ChangeNotifierProvider(create: (context) => AuthProvider()),
        ChangeNotifierProvider(create: (context) => TutorProvider()),
        ChangeNotifierProvider(create: (context) => MessageProvider()),
      ],
      child: MaterialApp(
        title: 'HiTutor 好会帮',
        theme: AppTheme.lightTheme,
        initialRoute: Routes.splash,
        routes: Routes.routes,
        debugShowCheckedModeBanner: false,
      ),
    );
  }
}
```

### 1.2 路由配置文件 (routes.dart)

```dart
class Routes {
  static const String splash = '/';
  static const String passwordLogin = '/auth/password-login';
  static const String smsLogin = '/auth/sms-login';
  static const String roleSelection = '/auth/role-selection';
  static const String forgotPassword = '/auth/forgot-password';
  static const String mainTab = '/main/tab';
  static const String home = '/main/home';
  static const String discover = '/main/discover';
  static const String message = '/main/message';
  static const String profile = '/main/profile';
  static const String publishTutorService = '/publish/tutor-service';
  static const String publishStudentRequest = '/publish/student-request';
  static const String tutorDetail = '/tutor/detail';
  static const String studentRequestDetail = '/student-request/detail';
  static const String chatDetail = '/chat/detail';
  static const String appointment = '/appointment';
  static const String createAppointment = '/appointment/create';
  static const String applicationList = '/application/list';
  static const String applicationDetail = '/application/detail';
  static const String applicationForm = '/application/form';
  static const String myApplications = '/application/my';
  static const String favorites = '/services/favorites';
  static const String myPublishings = '/services/my-publishings';
  static const String myReviews = '/services/my-reviews';
  static const String points = '/services/points';
  static const String pointsDetail = '/services/points-detail';
  static const String tutorCertification = '/services/tutor-certification';
  static const String tutorResume = '/services/tutor-resume';
  static const String customerService = '/services/customer-service';
  static const String settings = '/settings';
  static const String profileEdit = '/settings/profile-edit';
  static const String accountSecurity = '/settings/account-security';
  static const String changePhone = '/settings/change-phone';
  static const String changeEmail = '/settings/change-email';
  static const String blacklist = '/settings/blacklist';
  static const String notification = '/notification';
  static const String review = '/review';
  static const String aboutUs = '/about/about-us';
  static const String userAgreement = '/about/user-agreement';
  static const String privacyPolicy = '/about/privacy-policy';
  static const String complaint = '/about/complaint';
  static const String complaintList = '/about/complaint-list';
  static const String userProfile = '/user/profile';
  static const String subjectExplore = '/subject/explore';
  static const String map = '/map';
  static const String tutorServiceDetail = '/tutor-service/detail';

  static Map<String, WidgetBuilder> routes = {
    splash: (context) => const SplashPage(),
    passwordLogin: (context) => const PasswordLoginPage(),
    smsLogin: (context) => const SmsLoginPage(),
    roleSelection: (context) => const RoleSelectionPage(),
    forgotPassword: (context) => const ForgotPasswordPage(),
    mainTab: (context) => const MainTabPage(),
    home: (context) => const HomePage(),
    discover: (context) => const DiscoverPage(),
    message: (context) => const MessagePage(),
    profile: (context) => const ProfilePage(),
    publishTutorService: (context) => const PublishTutorServicePage(),
    publishStudentRequest: (context) => const PublishStudentRequestPage(),
    tutorDetail: (context) => const TutorDetailPage(),
    studentRequestDetail: (context) => const StudentRequestDetailPage(),
    chatDetail: (context) => const ChatDetailPage(),
    appointment: (context) => const AppointmentPage(),
    createAppointment: (context) => const CreateAppointmentPage(),
    applicationList: (context) => const ApplicationListPage(),
    applicationDetail: (context) => const ApplicationDetailPage(),
    applicationForm: (context) => const ApplicationFormPage(),
    myApplications: (context) => const MyApplicationsPage(),
    favorites: (context) => const FavoritesPage(),
    myPublishings: (context) => const MyPublishingsPage(),
    myReviews: (context) => const MyReviewsPage(),
    points: (context) => const PointsPage(),
    pointsDetail: (context) => const PointsDetailPage(),
    tutorCertification: (context) => const TutorCertificationPage(),
    tutorResume: (context) => const TutorResumePage(),
    customerService: (context) => const CustomerServicePage(),
    settings: (context) => const SettingsPage(),
    profileEdit: (context) => const ProfileEditPage(),
    accountSecurity: (context) => const AccountSecurityPage(),
    changePhone: (context) => const ChangePhonePage(),
    changeEmail: (context) => const ChangeEmailPage(),
    blacklist: (context) => const BlacklistPage(),
    notification: (context) => const NotificationPage(),
    review: (context) => const ReviewPage(),
    aboutUs: (context) => const AboutUsPage(),
    userAgreement: (context) => const UserAgreementPage(),
    privacyPolicy: (context) => const PrivacyPolicyPage(),
    complaint: (context) => const ComplaintPage(),
    complaintList: (context) => const ComplaintListPage(),
    userProfile: (context) => const UserProfilePage(),
    subjectExplore: (context) => const SubjectExplorePage(),
    map: (context) => const MapPage(),
    tutorServiceDetail: (context) => const TutorServiceDetailPage(),
  };
}
```

### 1.3 API服务文件 (api_service.dart)

```dart
import 'dart:convert';
import 'package:http/http.dart' as http;

class ApiService {
  static const String baseUrl = 'http://localhost:8080/api';

  static Future<Map<String, dynamic>> post(String endpoint, dynamic data, {String? token}) async {
    final url = Uri.parse('$baseUrl$endpoint');
    final headers = {
      'Content-Type': 'application/json',
      if (token != null) 'Authorization': 'Bearer $token',
    };
    final response = await http.post(
      url,
      headers: headers,
      body: jsonEncode(data),
    );
    return jsonDecode(response.body);
  }

  static Future<Map<String, dynamic>> get(String endpoint, {String? token}) async {
    final url = Uri.parse('$baseUrl$endpoint');
    final headers = {
      if (token != null) 'Authorization': 'Bearer $token',
    };
    final response = await http.get(
      url,
      headers: headers,
    );
    return jsonDecode(response.body);
  }

  static Future<Map<String, dynamic>> put(String endpoint, dynamic data, {String? token}) async {
    final url = Uri.parse('$baseUrl$endpoint');
    final headers = {
      'Content-Type': 'application/json',
      if (token != null) 'Authorization': 'Bearer $token',
    };
    final response = await http.put(
      url,
      headers: headers,
      body: jsonEncode(data),
    );
    return jsonDecode(response.body);
  }

  static Future<Map<String, dynamic>> delete(String endpoint, {String? token}) async {
    final url = Uri.parse('$baseUrl$endpoint');
    final headers = {
      if (token != null) 'Authorization': 'Bearer $token',
    };
    final response = await http.delete(
      url,
      headers: headers,
    );
    return jsonDecode(response.body);
  }
}
```

### 1.4 认证提供者 (auth_provider.dart)

```dart
import 'package:flutter/material.dart';
import '../models/user_model.dart';
import '../services/auth_service.dart';

class AuthProvider extends ChangeNotifier {
  UserModel? _user;
  String? _token;
  bool _isLoading = false;
  String? _error;

  UserModel? get user => _user;
  String? get token => _token;
  bool get isLoading => _isLoading;
  String? get error => _error;
  bool get isAuthenticated => _token != null && _user != null;

  Future<bool> loginWithPassword(String phone, String password) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      final result = await AuthService.loginWithPassword(phone, password);
      if (result['success']) {
        _token = result['data']['token'];
        _user = UserModel.fromJson(result['data']['user']);
        notifyListeners();
        return true;
      } else {
        _error = result['message'];
        notifyListeners();
        return false;
      }
    } catch (e) {
      _error = '登录失败，请稍后重试';
      notifyListeners();
      return false;
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<bool> loginWithSms(String phone, String code) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      final result = await AuthService.loginWithSms(phone, code);
      if (result['success']) {
        _token = result['data']['token'];
        _user = UserModel.fromJson(result['data']['user']);
        notifyListeners();
        return true;
      } else {
        _error = result['message'];
        notifyListeners();
        return false;
      }
    } catch (e) {
      _error = '登录失败，请稍后重试';
      notifyListeners();
      return false;
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<bool> register(String phone, String password, String role) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      final result = await AuthService.register(phone, password, role);
      if (result['success']) {
        _token = result['data']['token'];
        _user = UserModel.fromJson(result['data']['user']);
        notifyListeners();
        return true;
      } else {
        _error = result['message'];
        notifyListeners();
        return false;
      }
    } catch (e) {
      _error = '注册失败，请稍后重试';
      notifyListeners();
      return false;
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<void> logout() async {
    _user = null;
    _token = null;
    await AuthService.clearToken();
    notifyListeners();
  }

  Future<void> loadUser() async {
    final savedToken = await AuthService.getToken();
    if (savedToken != null) {
      _token = savedToken;
      try {
        final userData = await AuthService.getUserInfo(savedToken);
        if (userData['success']) {
          _user = UserModel.fromJson(userData['data']);
        }
      } catch (e) {
        // Token invalid, clear it
        await AuthService.clearToken();
        _token = null;
      }
      notifyListeners();
    }
  }
}
```

### 1.5 用户模型 (user_model.dart)

```dart
class UserModel {
  final String id;
  final String username;
  final String phone;
  final String? email;
  final String role;
  final bool isVerified;
  final int points;
  final String? avatar;
  final String? gender;
  final String? birthDate;
  final String? education;
  final String? school;
  final String? major;
  final int? teachingExperience;

  UserModel({
    required this.id,
    required this.username,
    required this.phone,
    this.email,
    required this.role,
    required this.isVerified,
    required this.points,
    this.avatar,
    this.gender,
    this.birthDate,
    this.education,
    this.school,
    this.major,
    this.teachingExperience,
  });

  factory UserModel.fromJson(Map<String, dynamic> json) {
    return UserModel(
      id: json['id'] ?? '',
      username: json['username'] ?? json['name'] ?? '',
      phone: json['phone'] ?? '',
      email: json['email'],
      role: json['role'] ?? '',
      isVerified: json['isVerified'] ?? false,
      points: json['points'] ?? 0,
      avatar: json['avatar'],
      gender: json['gender'],
      birthDate: json['birthDate'],
      education: json['education'],
      school: json['school'],
      major: json['major'],
      teachingExperience: json['teachingExperience'],
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'username': username,
      'phone': phone,
      'email': email,
      'role': role,
      'isVerified': isVerified,
      'points': points,
      'avatar': avatar,
      'gender': gender,
      'birthDate': birthDate,
      'education': education,
      'school': school,
      'major': major,
      'teachingExperience': teachingExperience,
    };
  }
}
```

### 1.6 家教提供者 (tutor_provider.dart)

```dart
import 'package:flutter/material.dart';
import '../models/tutor_model.dart';
import '../services/api_service.dart';

class TutorProvider extends ChangeNotifier {
  List<TutorModel> _tutors = [];
  List<TutorModel> _myTutors = [];
  TutorModel? _currentTutor;
  bool _isLoading = false;
  String? _error;

  List<TutorModel> get tutors => _tutors;
  List<TutorModel> get myTutors => _myTutors;
  TutorModel? get currentTutor => _currentTutor;
  bool get isLoading => _isLoading;
  String? get error => _error;

  Future<bool> fetchTutors({String? token, Map<String, dynamic>? filters}) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      final result = await ApiService.get('/tutor-profiles', token: token);
      if (result['success']) {
        _tutors = (result['data']['content'] as List)
            .map((item) => TutorModel.fromJson(item))
            .toList();
        notifyListeners();
        return true;
      } else {
        _error = result['message'];
        notifyListeners();
        return false;
      }
    } catch (e) {
      _error = '获取家教信息失败';
      notifyListeners();
      return false;
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<bool> fetchMyTutors(String token) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      final result = await ApiService.get('/tutor-profiles/my', token: token);
      if (result['success']) {
        _myTutors = (result['data'] as List)
            .map((item) => TutorModel.fromJson(item))
            .toList();
        notifyListeners();
        return true;
      } else {
        _error = result['message'];
        notifyListeners();
        return false;
      }
    } catch (e) {
      _error = '获取我的家教信息失败';
      notifyListeners();
      return false;
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<bool> publishTutorProfile(Map<String, dynamic> data, String token) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      final result = await ApiService.post('/tutor-profiles', data, token: token);
      if (result['success']) {
        notifyListeners();
        return true;
      } else {
        _error = result['message'];
        notifyListeners();
        return false;
      }
    } catch (e) {
      _error = '发布家教信息失败';
      notifyListeners();
      return false;
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<bool> getTutorDetail(String id, String token) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      final result = await ApiService.get('/tutor-profiles/$id', token: token);
      if (result['success']) {
        _currentTutor = TutorModel.fromJson(result['data']);
        notifyListeners();
        return true;
      } else {
        _error = result['message'];
        notifyListeners();
        return false;
      }
    } catch (e) {
      _error = '获取家教详情失败';
      notifyListeners();
      return false;
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }
}
```

## 二、后端源代码

### 2.1 应用入口文件 (HiTutorApplication.java)

```java
package com.hitutor;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.ComponentScan;

@SpringBootApplication
@ComponentScan(basePackages = "com.hitutor")
public class HiTutorApplication {
    public static void main(String[] args) {
        SpringApplication.run(HiTutorApplication.class, args);
    }
}
```

### 2.2 认证控制器 (AuthController.java)

```java
package com.hitutor.controller;

import com.hitutor.dto.UserDTO;
import com.hitutor.entity.User;
import com.hitutor.service.AuthService;
import com.hitutor.service.UserService;
import com.hitutor.utils.JwtUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.Map;

@RestController
@RequestMapping("/api/auth")
public class AuthController {

    @Autowired
    private AuthService authService;

    @Autowired
    private UserService userService;

    @Autowired
    private JwtUtil jwtUtil;

    @PostMapping("/login/password")
    public ResponseEntity<?> loginWithPassword(@RequestBody Map<String, String> request) {
        String phone = request.get("phone");
        String password = request.get("password");

        try {
            User user = authService.loginWithPassword(phone, password);
            String token = jwtUtil.generateToken(user.getId(), user.getRole());

            Map<String, Object> response = new HashMap<>();
            response.put("success", true);
            response.put("message", "登录成功");
            response.put("data", Map.of(
                    "token", token,
                    "user", UserDTO.fromUser(user)
            ));

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, Object> response = new HashMap<>();
            response.put("success", false);
            response.put("message", e.getMessage());
            response.put("data", null);

            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
        }
    }

    @PostMapping("/login/sms")
    public ResponseEntity<?> loginWithSms(@RequestBody Map<String, String> request) {
        String phone = request.get("phone");
        String code = request.get("code");

        try {
            User user = authService.loginWithSms(phone, code);
            String token = jwtUtil.generateToken(user.getId(), user.getRole());

            Map<String, Object> response = new HashMap<>();
            response.put("success", true);
            response.put("message", "登录成功");
            response.put("data", Map.of(
                    "token", token,
                    "user", UserDTO.fromUser(user)
            ));

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, Object> response = new HashMap<>();
            response.put("success", false);
            response.put("message", e.getMessage());
            response.put("data", null);

            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
        }
    }

    @PostMapping("/register")
    public ResponseEntity<?> register(@RequestBody Map<String, String> request) {
        String phone = request.get("phone");
        String password = request.get("password");
        String role = request.get("role");

        try {
            User user = authService.register(phone, password, role);
            String token = jwtUtil.generateToken(user.getId(), user.getRole());

            Map<String, Object> response = new HashMap<>();
            response.put("success", true);
            response.put("message", "注册成功");
            response.put("data", Map.of(
                    "token", token,
                    "user", UserDTO.fromUser(user)
            ));

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, Object> response = new HashMap<>();
            response.put("success", false);
            response.put("message", e.getMessage());
            response.put("data", null);

            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
        }
    }

    @PostMapping("/send-code")
    public ResponseEntity<?> sendCode(@RequestBody Map<String, String> request) {
        String phone = request.get("phone");

        try {
            authService.sendVerificationCode(phone);

            Map<String, Object> response = new HashMap<>();
            response.put("success", true);
            response.put("message", "验证码发送成功");
            response.put("data", null);

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, Object> response = new HashMap<>();
            response.put("success", false);
            response.put("message", e.getMessage());
            response.put("data", null);

            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
        }
    }
}
```

### 2.3 家教信息控制器 (TutorProfileController.java)

```java
package com.hitutor.controller;

import com.hitutor.dto.TutorProfileDTO;
import com.hitutor.entity.TutorProfile;
import com.hitutor.service.TutorProfileService;
import com.hitutor.utils.UserUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/tutor-profiles")
public class TutorProfileController {

    @Autowired
    private TutorProfileService tutorProfileService;

    @Autowired
    private UserUtil userUtil;

    @GetMapping
    public ResponseEntity<?> getTutorProfiles(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size,
            @RequestParam(required = false) Long subjectId,
            @RequestParam(required = false) String grade,
            @RequestParam(required = false) String sortBy
    ) {
        try {
            Map<String, Object> result = tutorProfileService.getTutorProfiles(page, size, subjectId, grade, sortBy);

            Map<String, Object> response = new HashMap<>();
            response.put("success", true);
            response.put("message", "获取家教列表成功");
            response.put("data", result);

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, Object> response = new HashMap<>();
            response.put("success", false);
            response.put("message", e.getMessage());
            response.put("data", null);

            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
        }
    }

    @GetMapping("/my")
    public ResponseEntity<?> getMyTutorProfiles() {
        try {
            String userId = userUtil.getCurrentUserId();
            List<TutorProfile> profiles = tutorProfileService.getMyTutorProfiles(userId);

            List<TutorProfileDTO> dtos = profiles.stream()
                    .map(TutorProfileDTO::fromTutorProfile)
                    .toList();

            Map<String, Object> response = new HashMap<>();
            response.put("success", true);
            response.put("message", "获取我的家教信息成功");
            response.put("data", dtos);

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, Object> response = new HashMap<>();
            response.put("success", false);
            response.put("message", e.getMessage());
            response.put("data", null);

            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
        }
    }

    @PostMapping
    public ResponseEntity<?> createTutorProfile(@RequestBody TutorProfileDTO dto) {
        try {
            String userId = userUtil.getCurrentUserId();
            TutorProfile profile = tutorProfileService.createTutorProfile(userId, dto);

            Map<String, Object> response = new HashMap<>();
            response.put("success", true);
            response.put("message", "发布家教信息成功");
            response.put("data", TutorProfileDTO.fromTutorProfile(profile));

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, Object> response = new HashMap<>();
            response.put("success", false);
            response.put("message", e.getMessage());
            response.put("data", null);

            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
        }
    }

    @GetMapping("/{id}")
    public ResponseEntity<?> getTutorProfile(@PathVariable Long id) {
        try {
            TutorProfile profile = tutorProfileService.getTutorProfile(id);

            Map<String, Object> response = new HashMap<>();
            response.put("success", true);
            response.put("message", "获取家教详情成功");
            response.put("data", TutorProfileDTO.fromTutorProfile(profile));

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, Object> response = new HashMap<>();
            response.put("success", false);
            response.put("message", e.getMessage());
            response.put("data", null);

            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
        }
    }

    @PutMapping("/{id}")
    public ResponseEntity<?> updateTutorProfile(@PathVariable Long id, @RequestBody TutorProfileDTO dto) {
        try {
            String userId = userUtil.getCurrentUserId();
            TutorProfile profile = tutorProfileService.updateTutorProfile(id, userId, dto);

            Map<String, Object> response = new HashMap<>();
            response.put("success", true);
            response.put("message", "更新家教信息成功");
            response.put("data", TutorProfileDTO.fromTutorProfile(profile));

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, Object> response = new HashMap<>();
            response.put("success", false);
            response.put("message", e.getMessage());
            response.put("data", null);

            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
        }
    }

    @DeleteMapping("/{id}")
    public ResponseEntity<?> deleteTutorProfile(@PathVariable Long id) {
        try {
            String userId = userUtil.getCurrentUserId();
            tutorProfileService.deleteTutorProfile(id, userId);

            Map<String, Object> response = new HashMap<>();
            response.put("success", true);
            response.put("message", "删除家教信息成功");
            response.put("data", null);

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, Object> response = new HashMap<>();
            response.put("success", false);
            response.put("message", e.getMessage());
            response.put("data", null);

            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
        }
    }
}
```

### 2.4 学生需求控制器 (StudentRequestController.java)

```java
package com.hitutor.controller;

import com.hitutor.dto.StudentRequestDTO;
import com.hitutor.entity.StudentRequest;
import com.hitutor.service.StudentRequestService;
import com.hitutor.utils.UserUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/student-requests")
public class StudentRequestController {

    @Autowired
    private StudentRequestService studentRequestService;

    @Autowired
    private UserUtil userUtil;

    @GetMapping
    public ResponseEntity<?> getStudentRequests(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size,
            @RequestParam(required = false) Long subjectId,
            @RequestParam(required = false) String grade,
            @RequestParam(required = false) String sortBy
    ) {
        try {
            Map<String, Object> result = studentRequestService.getStudentRequests(page, size, subjectId, grade, sortBy);

            Map<String, Object> response = new HashMap<>();
            response.put("success", true);
            response.put("message", "获取学生需求列表成功");
            response.put("data", result);

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, Object> response = new HashMap<>();
            response.put("success", false);
            response.put("message", e.getMessage());
            response.put("data", null);

            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
        }
    }

    @GetMapping("/my")
    public ResponseEntity<?> getMyStudentRequests() {
        try {
            String userId = userUtil.getCurrentUserId();
            List<StudentRequest> requests = studentRequestService.getMyStudentRequests(userId);

            List<StudentRequestDTO> dtos = requests.stream()
                    .map(StudentRequestDTO::fromStudentRequest)
                    .toList();

            Map<String, Object> response = new HashMap<>();
            response.put("success", true);
            response.put("message", "获取我的学生需求成功");
            response.put("data", dtos);

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, Object> response = new HashMap<>();
            response.put("success", false);
            response.put("message", e.getMessage());
            response.put("data", null);

            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
        }
    }

    @PostMapping
    public ResponseEntity<?> createStudentRequest(@RequestBody StudentRequestDTO dto) {
        try {
            String userId = userUtil.getCurrentUserId();
            StudentRequest request = studentRequestService.createStudentRequest(userId, dto);

            Map<String, Object> response = new HashMap<>();
            response.put("success", true);
            response.put("message", "发布学生需求成功");
            response.put("data", StudentRequestDTO.fromStudentRequest(request));

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, Object> response = new HashMap<>();
            response.put("success", false);
            response.put("message", e.getMessage());
            response.put("data", null);

            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
        }
    }

    @GetMapping("/{id}")
    public ResponseEntity<?> getStudentRequest(@PathVariable Long id) {
        try {
            StudentRequest request = studentRequestService.getStudentRequest(id);

            Map<String, Object> response = new HashMap<>();
            response.put("success", true);
            response.put("message", "获取学生需求详情成功");
            response.put("data", StudentRequestDTO.fromStudentRequest(request));

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, Object> response = new HashMap<>();
            response.put("success", false);
            response.put("message", e.getMessage());
            response.put("data", null);

            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
        }
    }

    @PutMapping("/{id}")
    public ResponseEntity<?> updateStudentRequest(@PathVariable Long id, @RequestBody StudentRequestDTO dto) {
        try {
            String userId = userUtil.getCurrentUserId();
            StudentRequest request = studentRequestService.updateStudentRequest(id, userId, dto);

            Map<String, Object> response = new HashMap<>();
            response.put("success", true);
            response.put("message", "更新学生需求成功");
            response.put("data", StudentRequestDTO.fromStudentRequest(request));

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, Object> response = new HashMap<>();
            response.put("success", false);
            response.put("message", e.getMessage());
            response.put("data", null);

            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
        }
    }

    @DeleteMapping("/{id}")
    public ResponseEntity<?> deleteStudentRequest(@PathVariable Long id) {
        try {
            String userId = userUtil.getCurrentUserId();
            studentRequestService.deleteStudentRequest(id, userId);

            Map<String, Object> response = new HashMap<>();
            response.put("success", true);
            response.put("message", "删除学生需求成功");
            response.put("data", null);

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, Object> response = new HashMap<>();
            response.put("success", false);
            response.put("message", e.getMessage());
            response.put("data", null);

            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
        }
    }
}
```

### 2.5 用户控制器 (UserController.java)

```java
package com.hitutor.controller;

import com.hitutor.dto.UserDTO;
import com.hitutor.entity.User;
import com.hitutor.service.UserService;
import com.hitutor.utils.UserUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.Map;

@RestController
@RequestMapping("/api/users")
public class UserController {

    @Autowired
    private UserService userService;

    @Autowired
    private UserUtil userUtil;

    @GetMapping("/me")
    public ResponseEntity<?> getCurrentUser() {
        try {
            String userId = userUtil.getCurrentUserId();
            User user = userService.getUserById(userId);

            Map<String, Object> response = new HashMap<>();
            response.put("success", true);
            response.put("message", "获取用户信息成功");
            response.put("data", UserDTO.fromUser(user));

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, Object> response = new HashMap<>();
            response.put("success", false);
            response.put("message", e.getMessage());
            response.put("data", null);

            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
        }
    }

    @PutMapping("/me")
    public ResponseEntity<?> updateCurrentUser(@RequestBody UserDTO userDTO) {
        try {
            String userId = userUtil.getCurrentUserId();
            User user = userService.updateUser(userId, userDTO);

            Map<String, Object> response = new HashMap<>();
            response.put("success", true);
            response.put("message", "更新用户信息成功");
            response.put("data", UserDTO.fromUser(user));

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, Object> response = new HashMap<>();
            response.put("success", false);
            response.put("message", e.getMessage());
            response.put("data", null);

            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
        }
    }

    @GetMapping("/{id}")
    public ResponseEntity<?> getUserById(@PathVariable String id) {
        try {
            User user = userService.getUserById(id);

            Map<String, Object> response = new HashMap<>();
            response.put("success", true);
            response.put("message", "获取用户信息成功");
            response.put("data", UserDTO.fromUser(user));

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, Object> response = new HashMap<>();
            response.put("success", false);
            response.put("message", e.getMessage());
            response.put("data", null);

            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
        }
    }

    @PutMapping("/password")
    public ResponseEntity<?> changePassword(@RequestBody Map<String, String> request) {
        try {
            String userId = userUtil.getCurrentUserId();
            String oldPassword = request.get("oldPassword");
            String newPassword = request.get("newPassword");

            userService.changePassword(userId, oldPassword, newPassword);

            Map<String, Object> response = new HashMap<>();
            response.put("success", true);
            response.put("message", "密码修改成功");
            response.put("data", null);

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, Object> response = new HashMap<>();
            response.put("success", false);
            response.put("message", e.getMessage());
            response.put("data", null);

            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
        }
    }

    @PutMapping("/phone")
    public ResponseEntity<?> changePhone(@RequestBody Map<String, String> request) {
        try {
            String userId = userUtil.getCurrentUserId();
            String newPhone = request.get("newPhone");
            String code = request.get("code");

            userService.changePhone(userId, newPhone, code);

            Map<String, Object> response = new HashMap<>();
            response.put("success", true);
            response.put("message", "手机号修改成功");
            response.put("data", null);

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, Object> response = new HashMap<>();
            response.put("success", false);
            response.put("message", e.getMessage());
            response.put("data", null);

            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
        }
    }
}
```

### 2.6 JWT工具类 (JwtUtil.java)

```java
package com.hitutor.utils;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import java.util.Date;
import java.util.HashMap;
import java.util.Map;

@Component
public class JwtUtil {

    @Value("${app.jwt.secret}")
    private String secret;

    @Value("${app.jwt.expiration}")
    private long expiration;

    public String generateToken(String userId, String role) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("userId", userId);
        claims.put("role", role);

        return Jwts.builder()
                .setClaims(claims)
                .setSubject(userId)
                .setIssuedAt(new Date())
                .setExpiration(new Date(System.currentTimeMillis() + expiration))
                .signWith(SignatureAlgorithm.HS256, secret)
                .compact();
    }

    public Claims extractClaims(String token) {
        return Jwts.parser()
                .setSigningKey(secret)
                .parseClaimsJws(token)
                .getBody();
    }

    public String getUserIdFromToken(String token) {
        return extractClaims(token).get("userId", String.class);
    }

    public String getRoleFromToken(String token) {
        return extractClaims(token).get("role", String.class);
    }

    public boolean isTokenExpired(String token) {
        return extractClaims(token).getExpiration().before(new Date());
    }

    public boolean validateToken(String token) {
        try {
            Jwts.parser().setSigningKey(secret).parseClaimsJws(token);
            return !isTokenExpired(token);
        } catch (Exception e) {
            return false;
        }
    }
}
```

### 2.7 用户工具类 (UserUtil.java)

```java
package com.hitutor.utils;

import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;

@Component
public class UserUtil {

    public String getCurrentUserId() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication == null || !authentication.isAuthenticated()) {
            throw new RuntimeException("用户未认证");
        }
        return authentication.getName();
    }

    public String getCurrentUserRole() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication == null || !authentication.isAuthenticated()) {
            throw new RuntimeException("用户未认证");
        }
        return authentication.getAuthorities().iterator().next().getAuthority();
    }

    public boolean isTutor() {
        return "tutor".equals(getCurrentUserRole());
    }

    public boolean isStudent() {
        return "student".equals(getCurrentUserRole());
    }

    public boolean isAdmin() {
        return "admin".equals(getCurrentUserRole());
    }
}
```

### 2.8 全局异常处理器 (GlobalExceptionHandler.java)

```java
package com.hitutor.config;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;

import java.util.HashMap;
import java.util.Map;

@ControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(Exception.class)
    public ResponseEntity<?> handleException(Exception e) {
        Map<String, Object> response = new HashMap<>();
        response.put("success", false);
        response.put("message", e.getMessage());
        response.put("data", null);

        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
    }

    @ExceptionHandler(RuntimeException.class)
    public ResponseEntity<?> handleRuntimeException(RuntimeException e) {
        Map<String, Object> response = new HashMap<>();
        response.put("success", false);
        response.put("message", e.getMessage());
        response.put("data", null);

        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
    }
}
```

### 2.9 安全配置 (SecurityConfig.java)

```java
package com.hitutor.config;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Autowired
    private JwtAuthenticationFilter jwtAuthenticationFilter;

    @Autowired
    private CustomAccessDeniedHandler customAccessDeniedHandler;

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
                .csrf(csrf -> csrf.disable())
                .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeRequests(authorize -> authorize
                        .antMatchers("/api/auth/**").permitAll()
                        .antMatchers("/api/verification/**").permitAll()
                        .antMatchers("/api/subjects/**").permitAll()
                        .antMatchers("/api/admin/**").hasAuthority("admin")
                        .anyRequest().authenticated()
                )
                .exceptionHandling(exception -> exception
                        .accessDeniedHandler(customAccessDeniedHandler)
                )
                .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration authenticationConfiguration) throws Exception {
        return authenticationConfiguration.getAuthenticationManager();
    }
}
```

### 2.10 JWT认证过滤器 (JwtAuthenticationFilter.java)

```java
package com.hitutor.config;

import com.hitutor.utils.JwtUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import javax.servlet.FilterChain;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.Collections;

@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    @Autowired
    private JwtUtil jwtUtil;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        String authorizationHeader = request.getHeader("Authorization");

        if (authorizationHeader != null && authorizationHeader.startsWith("Bearer ")) {
            String token = authorizationHeader.substring(7);

            if (jwtUtil.validateToken(token)) {
                String userId = jwtUtil.getUserIdFromToken(token);
                String role = jwtUtil.getRoleFromToken(token);

                UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(
                        userId,
                        null,
                        Collections.singletonList(new SimpleGrantedAuthority(role))
                );

                SecurityContextHolder.getContext().setAuthentication(authentication);
            }
        }

        filterChain.doFilter(request, response);
    }
}
```

## 三、源代码统计

### 3.1 前端代码统计
- **文件数量**: 约150个
- **代码行数**: 约25,000行
- **主要语言**: Dart

### 3.2 后端代码统计
- **文件数量**: 约120个
- **代码行数**: 约17,000行
- **主要语言**: Java

### 3.3 总计
- **文件数量**: 约270个
- **代码行数**: 约42,000行

## 四、技术栈

### 4.1 前端技术栈
- Flutter 3.2.6
- Dart 3.2.6
- Provider 6.1.0
- HTTP 1.1.0
- Shared Preferences 2.2.3
- AMap Flutter Map 3.0.0
- Geolocator 11.1.0
- Permission Handler 11.0.0

### 4.2 后端技术栈
- Spring Boot 3.1.0
- MyBatis Plus 3.5.4.1
- MySQL 8.0.33
- Java 17
- JWT 0.11.5
- WebSocket

## 五、项目结构

### 5.1 前端项目结构
```
client/
├── lib/
│   ├── models/         # 数据模型
│   ├── pages/          # 页面组件
│   │   ├── auth/       # 认证页面
│   │   ├── main/       # 主页面
│   │   ├── tutor/      # 家教相关页面
│   │   ├── student_request/ # 学生需求页面
│   │   ├── publish/    # 发布页面
│   │   ├── chat/       # 聊天页面
│   │   ├── appointment/ # 预约页面
│   │   ├── application/ # 报名页面
│   │   ├── services/   # 服务页面
│   │   ├── settings/   # 设置页面
│   │   ├── notification/ # 通知页面
│   │   ├── review/     # 评价页面
│   │   ├── about/      # 关于页面
│   │   ├── user/       # 用户页面
│   │   ├── subject/    # 科目页面
│   │   ├── map/        # 地图页面
│   │   └── tutor_service/ # 家教服务页面
│   ├── providers/      # 状态管理
│   ├── services/       # API接口
│   ├── theme/          # 主题配置
│   ├── utils/          # 工具类
│   ├── widgets/        # 自定义组件
│   ├── main.dart       # 应用入口
│   └── routes.dart     # 路由配置
├── android/            # Android平台代码
├── ios/                # iOS平台代码
├── web/                # Web平台代码
├── windows/            # Windows平台代码
├── linux/              # Linux平台代码
├── macos/              # macOS平台代码
└── pubspec.yaml        # Flutter配置
```

### 5.2 后端项目结构
```
hitutor-backend/
├── src/main/java/com/hitutor/
│   ├── config/         # 配置类
│   ├── controller/     # 控制器
│   ├── document/       # 文档
│   ├── dto/            # 数据传输对象
│   ├── entity/         # 实体类
│   ├── mapper/         # 数据访问层
│   ├── service/        # 服务层
│   ├── utils/          # 工具类
│   └── HiTutorApplication.java # 应用入口
├── src/main/resources/
│   ├── application.yml # 应用配置
│   └── application.properties # 应用配置
└── pom.xml             # Maven配置
```